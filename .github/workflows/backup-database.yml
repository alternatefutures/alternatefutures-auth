name: Backup SQLite Database

on:
  schedule:
    # Run daily at 5 AM UTC (offset from other backups)
    - cron: '0 5 * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install -g @web3-storage/w3cli
          sudo apt-get update
          sudo apt-get install -y age sqlite3

      - name: Get Akash deployment info from Infisical
        id: secrets
        env:
          INFISICAL_API_URL: https://secrets.alternatefutures.ai/api
        run: |
          # Get access token
          TOKEN_RESPONSE=$(curl -s -X POST "$INFISICAL_API_URL/v1/auth/universal-auth/login" \
            -H "Content-Type: application/json" \
            -d '{
              "clientId": "${{ secrets.INFISICAL_CLIENT_ID }}",
              "clientSecret": "${{ secrets.INFISICAL_CLIENT_SECRET }}"
            }')

          ACCESS_TOKEN=$(echo $TOKEN_RESPONSE | jq -r '.accessToken')

          if [ "$ACCESS_TOKEN" = "null" ] || [ -z "$ACCESS_TOKEN" ]; then
            echo "Failed to get access token"
            exit 1
          fi

          # For Akash deployment, SQLite is internal
          # We need to trigger backup via the service or use Akash MCP
          echo "SQLite database is internal to Akash deployment"
          echo "Backup must run inside the deployment via sidecar"
          echo "sidecar_mode=true" >> $GITHUB_OUTPUT

      - name: Trigger Akash backup sidecar
        if: steps.secrets.outputs.sidecar_mode == 'true'
        run: |
          echo "SQLite database is internal to Akash deployment"
          echo "The backup sidecar handles daily backups automatically"
          echo ""
          echo "To manually trigger or check backup status:"
          echo "1. Use Akash MCP: get-logs for the backup service"
          echo "2. Check GitHub artifacts from previous runs"
          echo ""
          echo "Backup sidecar uploads to:"
          echo "- Storacha (IPFS + Filecoin)"
          echo "- GitHub Artifacts (30 day retention)"

      # The following steps run if we can access the database directly
      # (e.g., for local testing or if DATABASE_URL is provided)
      - name: Run SQLite backup (direct access mode)
        if: steps.secrets.outputs.sidecar_mode == 'false'
        env:
          DATABASE_PATH: ${{ steps.secrets.outputs.database_path }}
        run: |
          TIMESTAMP=$(date -u +%Y%m%d-%H%M%S)
          BACKUP_FILE="backup-auth-${TIMESTAMP}.db"

          # Use sqlite3 .backup command for consistent backup
          sqlite3 "$DATABASE_PATH" ".backup '$BACKUP_FILE'"

          # Compress
          gzip "$BACKUP_FILE"

          echo "backup_file=${BACKUP_FILE}.gz" >> $GITHUB_ENV
          echo "timestamp=$TIMESTAMP" >> $GITHUB_ENV

      - name: Encrypt backup with age
        if: steps.secrets.outputs.sidecar_mode == 'false'
        env:
          AGE_PUBLIC_KEY: ${{ secrets.AGE_PUBLIC_KEY }}
        run: |
          echo "$AGE_PUBLIC_KEY" > age-recipient.txt
          age -R age-recipient.txt -o ${{ env.backup_file }}.age ${{ env.backup_file }}

          ls -la ${{ env.backup_file }}.age
          rm ${{ env.backup_file }}

      - name: Upload to Storacha (Web3.Storage)
        if: steps.secrets.outputs.sidecar_mode == 'false'
        env:
          W3_PRINCIPAL: ${{ secrets.W3_PRINCIPAL }}
          W3_PROOF: ${{ secrets.W3_PROOF }}
        run: |
          mkdir -p ~/.w3
          echo "$W3_PRINCIPAL" > ~/.w3/principal.json
          echo "$W3_PROOF" > ~/.w3/proof.json

          echo "Uploading to Storacha..."
          RESULT=$(w3 up ${{ env.backup_file }}.age 2>&1) || true

          echo "$RESULT"

          CID=$(echo "$RESULT" | grep -oE 'bafy[a-zA-Z0-9]+' | head -1 || echo "")

          if [ -n "$CID" ]; then
            echo "Backup uploaded to Storacha: $CID"
            echo "storacha_cid=$CID" >> $GITHUB_ENV
          else
            echo "Warning: Could not extract CID"
          fi

      - name: Upload backup as GitHub artifact
        if: steps.secrets.outputs.sidecar_mode == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: auth-backup-${{ github.run_id }}
          path: ${{ env.backup_file }}.age
          retention-days: 30

      - name: Log backup metadata
        run: |
          echo "=== Backup Status ==="
          if [ "${{ steps.secrets.outputs.sidecar_mode }}" == "true" ]; then
            echo "Mode: Akash Sidecar (automatic)"
            echo "The backup sidecar runs daily inside the Akash deployment"
          else
            echo "Mode: Direct"
            echo "Timestamp: ${{ env.timestamp }}"
            if [ -n "${{ env.storacha_cid }}" ]; then
              echo "Storacha CID: ${{ env.storacha_cid }}"
            fi
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "Auth database backup failed! Check the workflow logs."
