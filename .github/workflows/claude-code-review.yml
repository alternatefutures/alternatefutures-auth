name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  claude-review:
    runs-on: ubuntu-latest
    name: Review PR with Claude

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get the diff for this PR
          gh pr diff ${{ github.event.pull_request.number }} > pr_diff.txt

          # Check if diff is too large (Claude has context limits)
          DIFF_SIZE=$(wc -c < pr_diff.txt)
          if [ $DIFF_SIZE -gt 100000 ]; then
            echo "large_diff=true" >> $GITHUB_OUTPUT
          else
            echo "large_diff=false" >> $GITHUB_OUTPUT
          fi

      - name: Review with Claude
        if: steps.diff.outputs.large_diff == 'false'
        id: review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Create the review request
          cat > review_request.json <<'EOF'
          {
            "model": "claude-sonnet-4-20250514",
            "max_tokens": 4096,
            "messages": [
              {
                "role": "user",
                "content": "You are an expert code reviewer. Please review the following pull request diff and provide:\n\n1. **Security Issues**: Any security vulnerabilities or concerns\n2. **Bugs**: Potential bugs or logic errors\n3. **Code Quality**: Suggestions for improving code quality, readability, and maintainability\n4. **Best Practices**: Any violations of best practices or style guidelines\n5. **Performance**: Potential performance issues\n6. **Positive Notes**: What was done well\n\nBe concise but thorough. Format your response in markdown.\n\n## Pull Request Details\n- Title: ${{ github.event.pull_request.title }}\n- Author: @${{ github.event.pull_request.user.login }}\n- Branch: ${{ github.event.pull_request.head.ref }}\n\n## Diff\n\`\`\`diff\n$(cat pr_diff.txt)\n\`\`\`"
              }
            ]
          }
          EOF

          # Call Claude API
          RESPONSE=$(curl -s -X POST https://api.anthropic.com/v1/messages \
            -H "content-type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d @review_request.json)

          # Extract the review content
          REVIEW=$(echo "$RESPONSE" | jq -r '.content[0].text')

          # Save review to file for next step
          echo "$REVIEW" > review.md

      - name: Post review comment
        if: steps.diff.outputs.large_diff == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Create comment body
          cat > comment.md <<'EOF'
          ## ðŸ¤– Claude Code Review

          EOF
          cat review.md >> comment.md
          cat >> comment.md <<'EOF'

          ---
          *Automated review by [Claude Code](https://claude.com/claude-code) via GitHub Actions*
          EOF

          # Post comment to PR
          gh pr comment ${{ github.event.pull_request.number }} --body-file comment.md

      - name: Comment on large diff
        if: steps.diff.outputs.large_diff == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "## ðŸ¤– Claude Code Review

          âš ï¸ This PR diff is too large for automated review (>100KB). Please consider:
          - Breaking this PR into smaller, focused changes
          - Reviewing the changes manually
          - Using Claude Code CLI locally for review

          ---
          *Automated check by [Claude Code](https://claude.com/claude-code) via GitHub Actions*"
