name: Deploy to Akash

on:
  workflow_run:
    workflows: ["Build and Publish Docker Image"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

env:
  AKASH_NODE: https://rpc.akashnet.net:443
  AKASH_CHAIN_ID: akashnet-2
  AKASH_GAS_PRICES: 0.025uakt
  AKASH_GAS_ADJUSTMENT: "1.5"
  # Preferred provider (europlots - reliable)
  PREFERRED_PROVIDER: "akash18ga02jzaq8cw52anyhzkwta5wygufgu6zsz6xc"

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Akash CLI
        run: |
          # Install akash node CLI
          curl -sSfL https://raw.githubusercontent.com/akash-network/node/master/install.sh | sh -s -- -b /usr/local/bin
          akash version

          # Install provider-services CLI
          PROVIDER_VERSION=$(curl -s https://api.github.com/repos/akash-network/provider/releases/latest | jq -r '.tag_name')
          echo "Installing provider-services $PROVIDER_VERSION"
          curl -sSfL "https://github.com/akash-network/provider/releases/download/${PROVIDER_VERSION}/provider-services_linux_amd64.zip" -o /tmp/provider.zip
          unzip -o /tmp/provider.zip -d /usr/local/bin/
          chmod +x /usr/local/bin/provider-services

      - name: Setup Akash Wallet
        run: |
          mkdir -p $HOME/.akash
          echo "${{ secrets.AKASH_MNEMONIC }}" | akash keys add deployer --recover --keyring-backend=test --home $HOME/.akash
          export AKASH_FROM=$(akash keys show deployer -a --keyring-backend=test --home $HOME/.akash)
          echo "AKASH_FROM=$AKASH_FROM" >> $GITHUB_ENV
          echo "AKASH_HOME=$HOME/.akash" >> $GITHUB_ENV
          echo "Wallet address: $AKASH_FROM"

      - name: Setup Certificate
        run: |
          echo "Creating certificate for provider communication..."

          # Generate and broadcast certificate in one step
          akash tx cert generate client \
            --from deployer \
            --keyring-backend=test \
            --home $AKASH_HOME

          # Check if cert file exists
          ls -la $AKASH_HOME/

          if [ -f "$AKASH_HOME/$AKASH_FROM.pem" ]; then
            echo "Certificate file generated at $AKASH_HOME/$AKASH_FROM.pem"
          else
            echo "ERROR: Certificate file not found!"
            exit 1
          fi

          # Publish certificate to chain
          akash tx cert publish client \
            --from deployer \
            --keyring-backend=test \
            --home $AKASH_HOME \
            --yes \
            --gas-prices $AKASH_GAS_PRICES \
            --gas auto \
            --gas-adjustment $AKASH_GAS_ADJUSTMENT || echo "Certificate may already be published"

          sleep 10
          echo "Certificate setup complete"

      - name: Prepare SDL
        run: |
          # Create deployment SDL with secrets substituted
          cat > /tmp/deploy.yaml << EOF
          ---
          version: "2.0"

          services:
            auth-api:
              image: ghcr.io/alternatefutures/service-auth:v3-1765188513
              credentials:
                host: ghcr.io
                username: alternatefutures
                password: "${{ secrets.GHCR_PAT }}"
              expose:
                - port: 3000
                  as: 80
                  to:
                    - global: true
                  accept:
                    - auth.alternatefutures.ai
              env:
                - NODE_ENV=production
                - PORT=3000
                - DATABASE_URL=${{ secrets.DATABASE_URL }}
                - JWT_EXPIRES_IN=15m
                - JWT_REFRESH_EXPIRES_IN=7d
                - DOMAIN=alternatefutures.ai
                - APP_URL=https://auth.alternatefutures.ai
                - FRONTEND_URL=https://app.alternatefutures.ai
                - CORS_ORIGIN=https://app.alternatefutures.ai
                - GOOGLE_REDIRECT_URI=https://auth.alternatefutures.ai/auth/oauth/callback/google
                - GITHUB_REDIRECT_URI=https://auth.alternatefutures.ai/auth/oauth/callback/github
                - TWITTER_REDIRECT_URI=https://auth.alternatefutures.ai/auth/oauth/callback/twitter
                - DISCORD_REDIRECT_URI=https://auth.alternatefutures.ai/auth/oauth/callback/discord
                - INFISICAL_SITE_URL=https://secrets.alternatefutures.ai
                - INFISICAL_CLIENT_ID=${{ secrets.INFISICAL_CLIENT_ID }}
                - INFISICAL_CLIENT_SECRET=${{ secrets.INFISICAL_CLIENT_SECRET }}
                - INFISICAL_PROJECT_ID=${{ secrets.INFISICAL_PROJECT_ID }}
                - INFISICAL_ENVIRONMENT=prod

          profiles:
            compute:
              auth-api:
                resources:
                  cpu:
                    units: 1.0
                  memory:
                    size: 1Gi
                  storage:
                    - size: 1Gi

            placement:
              akash:
                attributes:
                  host: akash
                signedBy:
                  anyOf:
                    - "akash1365yvmc4s7awdyj3n2sav7xfx76adc6dnmlx63"
                pricing:
                  auth-api:
                    denom: uakt
                    amount: 100

          deployment:
            auth-api:
              akash:
                profile: auth-api
                count: 1
          EOF

          echo "SDL prepared"
          cat /tmp/deploy.yaml

      - name: Create Deployment
        id: create
        run: |
          echo "Creating new deployment..."

          # Create deployment and capture transaction
          akash tx deployment create /tmp/deploy.yaml \
            --from deployer \
            --keyring-backend=test \
            --home $AKASH_HOME \
            --yes \
            --gas-prices $AKASH_GAS_PRICES \
            --gas auto \
            --gas-adjustment $AKASH_GAS_ADJUSTMENT \
            --output json > /tmp/tx-result.json 2>&1 || true

          cat /tmp/tx-result.json

          # Wait for transaction to be included
          sleep 15

          # Extract DSEQ from transaction result (more reliable than querying deployments)
          echo "Extracting DSEQ from transaction result..."

          # The dseq is nested inside the "id" attribute as a JSON string
          # Event type: akash.deployment.v1.EventDeploymentCreated
          DSEQ=$(cat /tmp/tx-result.json | jq -r '
            .events[] |
            select(.type=="akash.deployment.v1.EventDeploymentCreated") |
            .attributes[] |
            select(.key=="id") |
            .value | fromjson | .dseq' 2>/dev/null)

          # Fallback: query deployments and get highest DSEQ (newest)
          if [ "$DSEQ" = "null" ] || [ -z "$DSEQ" ]; then
            echo "Could not extract from tx result, querying deployments..."
            akash query deployment list \
              --owner $AKASH_FROM \
              --output json > /tmp/deployments.json

            # Sort by DSEQ descending to get the newest
            DSEQ=$(cat /tmp/deployments.json | jq -r '
              .deployments |
              sort_by(.deployment.id.dseq | tonumber) |
              reverse |
              .[0].deployment.id.dseq')
          fi

          if [ "$DSEQ" = "null" ] || [ -z "$DSEQ" ]; then
            echo "ERROR: Could not extract DSEQ"
            cat /tmp/tx-result.json
            exit 1
          fi

          echo "New DSEQ: $DSEQ"
          echo "DSEQ=$DSEQ" >> $GITHUB_ENV

      - name: Wait for Bids
        run: |
          echo "Waiting for bids on DSEQ: $DSEQ"
          sleep 30

          # List bids
          akash query market bid list \
            --owner $AKASH_FROM \
            --dseq $DSEQ \
            --output json | jq '.bids'

      - name: Accept Bid from Preferred Provider
        run: |
          echo "Accepting bid from provider: $PREFERRED_PROVIDER"

          # Create lease with preferred provider
          akash tx market lease create \
            --dseq $DSEQ \
            --provider $PREFERRED_PROVIDER \
            --from deployer \
            --keyring-backend=test \
            --home $AKASH_HOME \
            --yes \
            --gas-prices $AKASH_GAS_PRICES \
            --gas auto \
            --gas-adjustment $AKASH_GAS_ADJUSTMENT

          sleep 10
          echo "Lease created"

      - name: Send Manifest
        run: |
          echo "Sending manifest to provider..."

          provider-services send-manifest /tmp/deploy.yaml \
            --dseq $DSEQ \
            --provider $PREFERRED_PROVIDER \
            --from deployer \
            --keyring-backend=test \
            --home $AKASH_HOME

          echo "Manifest sent"

      - name: Update Caddy Backend
        run: |
          echo "Waiting for service to be ready..."
          sleep 60

          # Get the new ingress URL
          INGRESS=$(provider-services lease-status \
            --dseq $DSEQ \
            --provider $PREFERRED_PROVIDER \
            --from deployer \
            --keyring-backend=test \
            --home $AKASH_HOME 2>/dev/null | jq -r '.services["auth-api"].uris[0]' || echo "")

          if [ -n "$INGRESS" ]; then
            echo "New ingress: $INGRESS"
            echo "INGRESS=$INGRESS" >> $GITHUB_ENV

            # Update Caddy route via Admin API
            # Note: This requires Caddy admin API to be accessible
            echo "TODO: Update Caddy route to point to $INGRESS"
          fi

      - name: Deployment Summary
        run: |
          echo "## Akash Deployment Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**DSEQ**: \`$DSEQ\`" >> $GITHUB_STEP_SUMMARY
          echo "**Provider**: \`$PREFERRED_PROVIDER\`" >> $GITHUB_STEP_SUMMARY
          echo "**URL**: https://auth.alternatefutures.ai" >> $GITHUB_STEP_SUMMARY
          if [ -n "$INGRESS" ]; then
            echo "**Ingress**: \`$INGRESS\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "⚠️ **Note**: Remember to close old deployments and update the DSEQ in this workflow" >> $GITHUB_STEP_SUMMARY
